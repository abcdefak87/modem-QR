<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Scan Barang Masuk/Keluar</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; }
    #reader { width: 300px; margin: 10px auto; }
    .ok { color: green; font-weight: bold; }
    .err { color: red; font-weight: bold; }
    .mode-select { margin: 15px 0; }
    input, button { padding: 6px; margin: 4px; }
</style>
</head>
<body>

<h2>üì¶ Scan Barang</h2>

<div class="mode-select">
    <label><input type="radio" name="mode" value="masuk" checked> Barang Masuk</label>
    <label><input type="radio" name="mode" value="keluar"> Barang Keluar</label>
</div>

<div>
    <input type="text" id="nama" placeholder="Scan atau ketik nama barang" autofocus>
    <input type="number" id="jumlah" value="1" min="1">
    <input type="text" id="petugas" placeholder="Nama Petugas">
    <input type="text" id="catatan" placeholder="Catatan">
    <button onclick="kirimManual()">Kirim Manual</button>
</div>

<hr>

<h3>üì∑ Scan via Kamera HP</h3>
<div id="reader"></div>

<div id="msg" style="margin-top:10px;">üîç Arahkan kamera ke kode...</div>

<!-- Beep Sound -->
<audio id="beep-sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxo8rvk6x5PGZOImUA5q7pkBC6SouF75YhvQWAIT3vCMxqk1WRvmw9R3WAf1oJcJ2cj/exec"; // Ganti dengan URL Apps Script

let lastScan = "";
let lastScanTime = 0;

function playBeep() {
    document.getElementById("beep-sound").play();
}

function kirimData(nama, jumlah, petugas, catatan, mode) {
    document.getElementById("msg").innerHTML = `üì§ Mengirim: ${nama}...`;
    fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({ 
            nama: nama,
            jumlah: jumlah,
            petugas: petugas,
            catatan: catatan,
            mode: mode
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "OK") {
            playBeep();
            document.getElementById("msg").innerHTML = `<span class="ok">‚úÖ ${nama} (${mode}) berhasil</span>`;
        } else {
            document.getElementById("msg").innerHTML = `<span class="err">‚ùå Gagal</span>`;
        }
    })
    .catch(err => {
        document.getElementById("msg").innerHTML = `<span class="err">‚ö†Ô∏è Error: ${err}</span>`;
    });
}

// Untuk scanner fisik / input manual
document.getElementById("nama").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        kirimManual();
    }
});

function kirimManual() {
    const nama = document.getElementById("nama").value.trim();
    const jumlah = document.getElementById("jumlah").value;
    const petugas = document.getElementById("petugas").value.trim();
    const catatan = document.getElementById("catatan").value.trim();
    const mode = document.querySelector('input[name="mode"]:checked').value;
    if (nama) {
        kirimData(nama, jumlah, petugas, catatan, mode);
        document.getElementById("nama").value = "";
        document.getElementById("nama").focus();
    }
}

// Untuk kamera HP (html5-qrcode)
function onScanSuccess(decodedText) {
    const now = Date.now();
    if (decodedText === lastScan && (now - lastScanTime) < 3000) {
        // Abaikan scan duplikat < 3 detik
        return;
    }
    lastScan = decodedText;
    lastScanTime = now;

    const jumlah = document.getElementById("jumlah").value;
    const petugas = document.getElementById("petugas").value.trim();
    const catatan = document.getElementById("catatan").value.trim();
    const mode = document.querySelector('input[name="mode"]:checked').value;

    kirimData(decodedText, jumlah, petugas, catatan, mode);
}

const html5QrCode = new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
        let backCamera = cameras.find(cam => 
            cam.label.toLowerCase().includes('back') || 
            cam.label.toLowerCase().includes('rear') || 
            cam.label.toLowerCase().includes('environment')
        );
        let cameraId = backCamera ? backCamera.id : cameras[cameras.length - 1].id;

        html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 200 },
            onScanSuccess
        );
    }
}).catch(err => {
    document.getElementById("msg").innerHTML = `<span class="err">‚ö†Ô∏è Kamera gagal dibuka</span>`;
});
</script>

</body>
</html>
